<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Wiggum E2E Bridge - Loading...</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@xterm/xterm@5/css/xterm.min.css" />
  <style>
    html, body { margin: 0; padding: 0; height: 100%; background: #1e1e1e; overflow: hidden; }
    #terminal { height: 100%; }
    #terminal-mirror {
      position: absolute; left: -9999px; top: 0;
      white-space: pre; font-family: monospace; font-size: 14px;
      aria-live: polite;
    }
  </style>
</head>
<body>
  <div id="terminal"></div>
  <pre id="terminal-mirror" aria-live="polite"></pre>

  <script type="module">
    import { Terminal } from 'https://cdn.jsdelivr.net/npm/@xterm/xterm@5/+esm';
    import { FitAddon } from 'https://cdn.jsdelivr.net/npm/@xterm/addon-fit@0/+esm';

    const params = new URLSearchParams(location.search);
    const cols = parseInt(params.get('cols') || '120', 10);
    const rows = parseInt(params.get('rows') || '30', 10);

    const term = new Terminal({
      cols, rows,
      screenReaderMode: true,
      fontFamily: 'monospace',
      fontSize: 14,
      theme: { background: '#1e1e1e' },
    });

    const fitAddon = new FitAddon();
    term.loadAddon(fitAddon);
    term.open(document.getElementById('terminal'));
    fitAddon.fit();

    const mirror = document.getElementById('terminal-mirror');
    let mirrorTimer = null;

    function updateMirror() {
      clearTimeout(mirrorTimer);
      mirrorTimer = setTimeout(() => {
        const buf = term.buffer.active;
        const lines = [];
        for (let i = 0; i < buf.length; i++) {
          const line = buf.getLine(i);
          if (line) lines.push(line.translateToString(true));
        }
        // Trim trailing empty lines
        while (lines.length > 0 && lines[lines.length - 1].trim() === '') lines.pop();
        mirror.textContent = lines.join('\n');
      }, 100);
    }

    const wsProto = location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = `${wsProto}//${location.host}?${params.toString()}`;
    const ws = new WebSocket(wsUrl);

    ws.onopen = () => {
      document.title = `Wiggum E2E Bridge - Ready (${cols}x${rows})`;
    };

    ws.onmessage = (event) => {
      term.write(event.data);
      updateMirror();
    };

    ws.onclose = () => {
      document.title = 'Wiggum E2E Bridge - Disconnected';
      term.write('\r\n\x1b[90m[session ended]\x1b[0m\r\n');
      updateMirror();
    };

    term.onData((data) => {
      if (ws.readyState === WebSocket.OPEN) ws.send(data);
    });

    window.addEventListener('resize', () => fitAddon.fit());
  </script>
</body>
</html>
